generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  profile       Profile?
  refreshTokens RefreshToken[]

  tasks         UserTask[]
  documents     Document[]
  posts         Post[]
  replies       Reply[]
}

model Profile {
  id        String @id @default(cuid())
  userId    String @unique

  fullName    String?
  nationality String?
  city        String?
  visaType    String?
  purpose     String?

  visaShareCode String?
  visaExpiryDate DateTime?

  consentTerms Boolean @default(false)
  consentAI    Boolean @default(false)

  // Notification Settings
  notificationEmail    Boolean @default(true)
  notificationPush     Boolean @default(true)

  // Privacy & Security Settings
  profileVisible       Boolean @default(true)
  showNationality      Boolean @default(true)
  showLocation         Boolean @default(true)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String
  createdAt DateTime @default(now())
  revokedAt DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model TaskTemplate {
  id              String   @id @default(cuid())
  title           String
  description     String

  category        String
  defaultPriority String   @default("MEDIUM")

  visaTypeMatch      String?
  purposeMatch       String?
  cityMatch          String?
  nationalityMatch   String?

  officialUrl     String?
  sortOrder       Int      @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  userTasks       UserTask[]
}

model UserTask {
  id          String   @id @default(cuid())
  userId      String
  templateId  String?

  title       String
  description String

  category    String
  priority    String   @default("MEDIUM")
  status      String   @default("PENDING")

  dueAt       DateTime?
  completedAt DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  template    TaskTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  reminders   Reminder[]

  @@index([userId])
  @@index([status])
  @@unique([userId, templateId])
}

model Document {
  id           String   @id @default(cuid())
  userId       String

  originalName String
  storedName   String
  mimeType     String
  sizeBytes    Int

  category     String   @default("OTHER")
  notes        String?

  createdAt    DateTime @default(now())

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model LocalService {
  id          String   @id @default(cuid())
  name        String
  category    String
  city        String
  address     String?
  phone       String?
  website     String?
  description String?

  createdAt   DateTime @default(now())

  @@index([city])
  @@index([category])
}

model Post {
  id        String   @id @default(cuid())
  userId    String

  title     String?
  body      String
  city      String?
  tags      String?

  createdAt DateTime @default(now())

  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  replies   Reply[]

  @@index([createdAt])
}

model Reply {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  body      String
  createdAt DateTime @default(now())

  post      Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([postId])
}

model FaqEntry {
  id          String   @id @default(cuid())
  city        String?
  visaType    String?
  topic       String
  question    String
  answer      String
  officialUrl String?
  createdAt   DateTime @default(now())

  @@index([topic])
}

model Reminder {
  id         String   @id @default(cuid())
  userTaskId String
  userId     String
  remindAt   DateTime
  sentAt     DateTime?
  channel    String   @default("in_app")

  createdAt  DateTime @default(now())

  task       UserTask @relation(fields: [userTaskId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sentAt])
  @@index([remindAt])
}
